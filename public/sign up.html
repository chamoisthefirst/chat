<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title id="title">Sign up</title>
        <link rel="stylesheet" type="text/css" href="darkmode.css">
    </head>
    <body>
        <div id="login">
            <h1>Sign Up</h1>
            <input id="username" placeholder="username">
            <input id="password" placeholder="password" type="password">
            <input id="password2" placeholder="repeat password" type="password">
            <h5 id="unfilled" class="hidden alert"><br>You have unfilled feilds!</h5>
            <h5 id="username_taken" class="hidden alert">That username is already take, try another.</h5>
            <h5 id="incongruent_password" class="hidden alert">Passwords must match</h5>
            <h4 id="register">Already have an account? <a href="./login.html">login here!</a></h3>
            <button id="login_button" onClick="register()"><h3>Register</h3></button>
        </div>
        <script>
            function del(){
                localStorage.removeItem("userId")
            }
            let storage = {}
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    storage = JSON.parse(xhttp.responseText)
                }
            }
            xhttp.open("GET", "../storage.json",true);
            xhttp.send();

            function save(){
                const options = {
                    "method": 'POST',
                    headers:{
                        "content-type":"application/json"
                    },
                    "body":JSON.stringify(storage)
                }
                fetch('/api', options)
            }

            function unfilled(){
                document.getElementById("unfilled").classList.remove("hidden")
                document.getElementById("css").innerHTML = "#login_button{border-color:#D22;}"
            }

            function register(){
                const username = document.getElementById("username").value
                const password = document.getElementById("password").value
                const password2 = document.getElementById("password2").value

                if(!username || !password || !password2){
                    return unfilled()
                }
                document.getElementById("unfilled").classList.add("hidden")
                if(password != password2){
                    return document.getElementById("incongruent_password").classList.remove("hidden")
                }
                document.getElementById("incongruent_password").classList.add("hidden")
                for(var i = 0; i < storage.users.length; i++){
                    if(storage.users[i].name.toLowerCase() === username.toLowerCase()){
                        return document.getElementById("username_taken").classList.remove("hidden")
                    }
                }

                const newUser = {
                    "id":storage.users.length,
                    "name":username.toLowerCase(),
                    "password":password,
                    "lightmode":true,
                    "bot":false,
                    "timeout":Date.now()+1800000
                }

                storage.users.push(newUser)

                localStorage.userId=newUser.id

                save()

                window.location.replace("./index.html")
            }
        </script>
    </body>
</html>