<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title id="title">Chat</title>
        <link rel="stylesheet" type="text/css" href="index.css">
        <div id="css">
            <link rel="stylesheet" type="text/css" href="darkmode.css">
        </div>
    </head>
    <body>
        <div id="chat">
            <header id="header">

                        </header>
            <div id="sidebar">

            </div>
            <div id="text">
                <div id="messages">

                </div>
                <input id="input" list="commands" dropzone="copy"></textarea>
                <datalist id="commands">
                    <option>/calc [num,operator,num] - calculate</option>
                     <option>/help - command list</option>
                     <option>/rot [message] - shift cypher</option>
                     <option>/say [message] - make the bot say something</option>
                     <option>/time - see what time it is</option>
                </datalist>
            </div>
            <div id="participants">
            </div>
            <div id="settings">
                <button class="setting_button" id="theme" onClick="changeTheme()"><h3>Theme</h3></button><br>
                <button class="setting_button" id="autoscroll" onClick="switchAutoscroll()"><h3>autoscroll</h3></button><br>
                <button class="setting_button" id="logout" onClick="logout()"><h3>Log out</h3></button><br>
            </div>
        </div>
        <script>


function del(){           
    localStorage.removeItem("userId")
}

let userId

let autoscroll = true;

function switchAutoscroll(){
    switch(autoscroll){
        case true:
            autoscroll = false;
        break;
        default:
            autoscroll = true;
    }
}
userId = localStorage.userId


function dispMsgs(){
    document.getElementById("messages").innerHTML=""
    for(var i = 0; i < storage.messages.length; i++){
        const msg = storage.messages[i]
        let User = storage.users[msg.author]
        User.name = `${User.name[0].toUpperCase()}${User.name.substring(1,User.name.length)}` 
        const user = User
        if(user.color){
            document.getElementById("messages").innerHTML += `<br><br><span class="username message_info" style="color:${user.color};">${user.name} </span><span class="timestamp message_info">- ${msg.timestamp}</span><br><span class="message_content">${msg.content}</span>`
        }else{
            document.getElementById("messages").innerHTML += `<br><br><span class="username message_info ${user.name.toLowerCase()}">${user.name} </span><span class="timestamp message_info">- ${msg.timestamp}</span><br><span class="message_content">${msg.content}</span>`
        }
            if(autoscroll){
            document.getElementById("messages").scroll(0, 10000000)
        }
    }
    document.getElementById("participants").innerHTML = "<br>"
    for(var i = 0; i < storage.users.length; i++){
        const n = storage.users[i].name
        n[0] = n[0].toUpperCase()
        const name = n
        document.getElementById("participants").innerHTML += `<span class="part ${storage.users[i].name.toLowerCase()}">${name}</span><br>`
    }
}

let fetched = false;

let storage = {}

var xhttp = new XMLHttpRequest();
xhttp.onreadystatechange = function() {
    if(this.readyState == 4 && this.status == 200){
        storage = JSON.parse(xhttp.responseText)
        if(!localStorage.userId || storage.users[localStorage.userId].timeout < Date.now()){
            window.location.replace("./login.html")
        }
        fetched = true;
    }
}
xhttp.open("GET", "storage.json",true);
xhttp.send();

/*
async function getData(){
    const response = await fetch('/api')
    storage = await response.json()
}
getData()
*/
function save(){
    const options = {
        "method": 'POST',
        headers:{
            "content-type":"application/json"
        },
        "body":JSON.stringify(storage)
    }
    fetch('/api', options)
    fetch('/api-temp',options)
}

function changeTheme(){
    switch(storage.users[userId].lightmode){
        case false:
            storage.users[userId].lightmode = true;
        break;
        default:
            storage.users[userId].lightmode = false;
    }

    save();
    if(storage.users[userId].timeout < Date.now() + 1000){
        storage.users[userId].timeout = Date.now() + 2000
    }
    window.location.reload()
}

function reloadMessages(){
    
    xhttp.open("GET", "storage.json",true);
    xhttp.send();
    dispMsgs()
    /*
    getData().then(()=>{ 
        dispMsgs()
    })*/
}



function logout(){
    storage.users[userId].timeout=Date.now()-1800000
    save()
    window.location.reload()
}

let loading = setInterval(()=>{
    if(fetched = true){
        dispMsgs()
        if(storage.users[userId].lightmode){
            document.getElementById("css").innerHTML = '<link rel="stylesheet" type="text/css" href="darkmode.css">'
        }else{
            document.getElementById("css").innerHTML = '<link rel="stylesheet" type="text/css" href="lightmode.css">'
        }
        document.getElementById("messages").scroll(0, 10000000)
        clearInterval(loading)
    }
},100)

let shift = false;

document.getElementById("input").onkeyup = (e)=>{
    if(e.key === "Shift"){
        shift = false;
    }
    if(e.key === "Enter" && shift === false){
        document.getElementById("input").value = ""
    }
}

document.getElementById("input").onkeydown = (e)=>{
    if(e.key === "Shift"){
        shift = true
    }
    if(e.key != "Enter" || shift)return;

    const message = {
        "content":document.getElementById("input").value,
        "author":parseInt(userId),
        "timestamp":Date().substring(0,21),
        "bot":false,
    }

    console.log(JSON.stringify(message))

    if(!message.content)return;

    const msg = {
        "content":message.content,
        "author":storage.users[userId],
        "timestamp":message.timestamp,
        "bot":false,
    }


    dispMsgs()

    const prefix = "/"
    const args = message.content.substring(prefix.length,message.content.length).split(" ").slice(1)
    const command = message.content.substr(prefix.length).split(" ")[0]

    let sent;

    function sendIt(){
        if(!message.content)return;
        storage.messages.push(message)
        save()
        dispMsgs()
        sent=true;
    }
    function send(content,bot){
        if(!content)return;
        const messag={
            "author":0,
            "content":`${content}`,
            "timestamp":Date().substring(0,21),
            "bot":true
        }
        storage.messages.push(messag)
        save()
        dispMsgs()
        document.getElementById("input").value=""
        sent = true;
    }

    if(msg.content.startsWith(prefix)){
        console.log(`${storage.users[message.author].name} called /${command} with args ${args}`)
        //COMMANDS
        if(command === "help"){
            sendIt()
            console.log("help")
            var commands = ["calc","help","rot","say","time"]
            var defs = ["Calculator.","This command menu.","A rot 13 cypher",`Make me say something, try ${prefix}say Hello there`,"Check the time in UTC, easter, weatstern, and moutain times."]  
            let cmnds = "";
            for(var i = 0; i < commands.length; i++){
            cmnds += ` â€¢ ${prefix}${commands[i]} - ${defs[i]}<br>`
            }
            send(`${cmnds}`);
        }
    
        if(command === "time"){
    
            sendIt()
    
            let hour = Math.floor((Date.now()%86400000)/3600000);
            let minute = Math.floor((Date.now()%86400000)/60000)%60;
    
            let times = `eastern: ${hour-5}:${minute}<br>central: ${hour-6}:${minute}<br>mountain: ${hour-7}:${minute} <br> western: ${hour-8}:${minute}<br>`
          
            send(times)
        }
    
        if(command === "del"){
            sendIt()
            send("do you want to delete all messages?console y or n")
            bool = "del"
        }
    
        if(command === "rot"){
            let out = ""
            const msg=message.content.slice(prefix.length+3)
            if(!msg){
                send("Please specify what you want me to encode.")
                return;
    
            }else{
    
                const chars="a|b|c|d|e|f|g|h|i|j|k|l|m|n|o|p|q|r|s|t|u|v|w|x|y|z".split('|');
                const altChars="n|o|p|q|r|s|t|u|v|w|x|y|z|a|b|c|d|e|f|g|h|i|j|k|l|m".split('|');
                for(var i=0; i<msg.length; i++){
                    if(!chars.includes(msg[i].toLowerCase())){
                        out+=msg[i]
                    }else{
                    for(var j=0; j<chars.length; j++){
                        if(msg[i].toLowerCase()===chars[j]){
                            if(msg[i]===msg[i].toUpperCase()){
                                out+=altChars[j].toUpperCase()
                            }else{
                                out+=altChars[j]
                            }
        
                        }
                    }
                }
            }
        }
        send(out)
        }
    
        if(command === "say"){
            send(args.join(" "))
        }
    
    
    
    
        }
    
    
        if(command === "calc"){
    if(!args[0]){
      send("Really? I have to have something to calculate.")
    };
    let num1 = parseFloat(args[0]);
    let num2 = parseFloat(args [2]);
    let opperator = args[1];
    if(args[0].includes("+")){
      args[0].split("+")
      num1 = parseFloat(args[0][0])
      num2 = parseFloat(args[0][2])
      opperator = "+"
    }
    if(args[0].includes("-")){
      args[0].split("-")
      num1 = parseFloat(args[0][0])
      num2 = parseFloat(args[0][2])
      opperator = "-"
    }
    if(args[0].includes("*") || args[0].includes("x") || args[0].includes("X")){
      args[0].split("*","x","X")
      num1 = parseFloat(args[0][0])
      num2 = parseFloat(args[0][2])
      opperator = "*"
    }
    if(args[0].includes("/")){
      args[0].split("/")
      num1 = parseFloat(args[0][0])
      num2 = parseFloat(args[0][2])
      opperator = "/"
    }
    let output = 0;
    switch(opperator){
      case "+":
        output = num1 + num2;
      break;
      case "-":
        output = num1 - num2;
      break;
      case "*":
        output = num1 * num2;
      break;
      case "x":
        output = num1 * num2;
      break;
      case "X":
        output = num1 * num2;
      break;
      case "/":
        output = num1 / num2;
      break;
      case "":
        output = num1 / num2;
      break;
    
      default:
        send(`${opperator} is not a valid opperation!`);
        return;
    }
    send(`${num1} ${opperator} ${num2} = ${output}`)
    return;
    }

    if(command === "runcode=>"){
        sent=true;
        console.log(args.join(" "))
        if(!args[0].startsWith("<")){
            sendIt();
            return console.log("not valid html code")
        }
        document.getElementById("messages").innerHTML+=args.join(" ")
    }








    
    if(!sent){
    sendIt()
    }
    
    
        //"CONSOLE" COMMANDS
        if(!message.content.startsWith("-"))return;
    
        if(command === "y"){
            switch(bool){
                case "del":
                msgData={"nextId":0}
                save()
                location.reload()
            break;
            }
        }
    
        if(command === "n"){
            bool = false;
        }
}
        </script>
    </body>
</html>